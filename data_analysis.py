#!/usr/bin/env python3
"""
Анализ и коррекция данных психодиагностического исследования
Идентификация эмоций у младших школьников с ЗПР
"""

import numpy as np
from scipy import stats
import warnings
warnings.filterwarnings('ignore')

# =============================================================================
# ИСХОДНЫЕ ДАННЫЕ
# =============================================================================

# Приложение 2: Анкета педагогу
anketa_zpr = {
    'express': [1,2,1,1,1,0,0,0,2,1,1,1,1,1,0,1,1,1,1,2,1,2,0,1,2],
    'understand_self': [1,2,1,1,1,0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,2,2,1,1,1],
    'understand_others': [1,1,2,1,2,0,0,1,2,0,1,0,2,2,1,1,1,1,1,1,0,1,0,1,2],
    'friends': [0,0,2,2,2,1,0,1,2,1,1,1,1,1,2,2,1,1,0,1,0,1,0,1,1]
}

anketa_norm = {
    'express': [1,1,0,1,1,0,1,1,2,0,2,1,1,1,2,1,1,1,1,1,1,2,1,2,2],
    'understand_self': [2,1,1,1,1,1,1,1,2,1,1,2,1,0,1,0,1,0,1,1,1,1,0,1,2],
    'understand_others': [2,1,1,1,1,0,0,1,1,1,2,1,1,0,1,1,1,0,1,1,0,2,0,2,1],
    'friends': [1,1,1,1,2,0,0,1,1,1,2,2,1,1,1,2,1,0,2,2,0,1,1,1,1]
}

# Приложение 3: Эмоциональная пиктограмма
# РЕ, В, УОЗ, ЭО, ФЭН
piktogramma_norm = {
    'RE': [10,11,10,9,12,10,11,10,10,11,10,11,10,9,10,11,10,10,11,10,11,10,10,11,10],
    'V': [11,12,11,10,12,11,11,11,11,12,12,11,11,11,11,12,11,11,12,11,12,11,11,12,11],
    'UOZ': [10,11,10,10,12,10,11,11,10,11,10,11,11,10,10,11,10,10,11,10,10,10,10,11,11],
    'EO': [10,10,9,9,11,10,10,10,10,11,10,10,10,9,9,11,10,10,10,10,10,10,10,11,10],
    'FEN': [8,9,8,7,9,9,8,8,8,9,8,8,9,8,9,8,8,8,8,9,9,9,8,8,8]
}

piktogramma_zpr = {
    'RE': [10,10,10,10,11,11,10,10,11,10,10,10,11,10,10,11,10,11,11,10,10,10,10,10,10],
    'V': [7,6,7,8,7,7,6,7,8,7,6,7,7,8,7,7,6,7,8,7,7,8,7,6,7],
    'UOZ': [10,10,10,10,11,11,10,10,10,10,10,10,11,10,11,11,10,10,11,10,10,10,10,11,10],
    'EO': [10,10,10,10,9,10,9,10,10,9,9,9,10,10,10,10,10,10,10,10,10,10,10,9,10],
    'FEN': [9,8,8,8,8,9,9,8,8,8,8,8,9,8,8,9,8,8,8,8,9,9,8,8,8]
}

# Приложение 4: Эмоциональные лица
# АО, ЯЭО, УД, ГВ
emolica_norm = {
    'AO': [8,9,8,8,9,8,8,8,9,8,8,9,9,8,8,8,8,8,8,9,9,9,8,8,8],
    'YaEO': [7,7,8,8,8,8,8,7,8,8,8,7,8,7,8,8,8,8,8,8,7,7,8,8,8],
    'UD': [8,8,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,7],
    'GV': [8,8,8,9,9,8,8,8,8,8,8,8,8,8,9,8,8,8,8,8,8,8,8,8,9]
}

emolica_zpr = {
    'AO': [7,7,7,7,7,7,6,7,7,7,7,7,7,7,7,7,7,7,7,7,6,7,7,6,6],
    'YaEO': [8,8,8,7,7,7,7,7,8,8,7,7,7,8,7,8,7,8,7,7,8,8,8,7,7],
    'UD': [6,6,6,6,6,6,6,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,5,6],
    'GV': [8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8]
}

# Приложение 5: Социометрия
# Личн+, Личн-, Позн+, Позн-, Личн статус, Позн статус, Общий статус
sociometry_norm = {
    'lich_plus': [4,3,5,2,4,3,1,5,4,3,5,2,4,3,5,2,4,3,5,2,4,3,1,5,4],
    'lich_minus': [2,3,1,4,2,3,5,1,2,3,1,4,2,3,1,4,2,2,1,4,2,3,5,1,2],
    'pozn_plus': [3,2,3,1,3,2,1,3,2,3,2,2,3,2,3,2,3,2,3,1,3,2,1,3,2],
    'pozn_minus': [1,1,0,2,0,1,2,0,1,0,1,2,0,1,0,2,0,1,0,2,0,1,2,0,1],
    'lich_status': [2,0,4,-2,2,0,-4,4,2,0,4,-2,2,0,4,-2,2,1,4,-2,2,0,-4,4,2],
    'pozn_status': [2,1,3,-1,3,1,-1,3,1,3,1,0,3,1,3,0,3,1,3,-1,3,1,-1,3,1],
    'total_status': [2.0,0.5,3.5,-1.5,2.5,0.5,-2.5,3.5,1.5,1.5,2.5,-1.0,2.5,0.5,3.5,-1.0,2.5,1.0,3.5,-1.5,2.5,0.5,-2.5,3.5,1.5]
}

sociometry_zpr = {
    'lich_plus': [1,1,2,3,3,1,1,2,3,2,1,3,2,4,3,1,1,2,3,4,1,3,2,1,3],
    'lich_minus': [4,4,3,5,5,5,4,5,4,3,5,3,4,2,5,3,4,5,3,2,5,3,5,3,4],
    'pozn_plus': [2,1,3,2,2,1,2,1,2,3,1,2,2,3,1,2,1,3,2,2,1,2,1,3,2],
    'pozn_minus': [1,2,1,2,1,2,1,2,1,0,2,1,1,0,2,1,2,0,1,1,2,1,2,0,1],
    'lich_status': [-3,-3,-1,-2,-2,-4,-3,-3,-1,-1,-4,0,-2,2,-2,-2,-3,-3,0,2,-4,0,-3,-2,-1],
    'pozn_status': [1,-1,2,0,1,-1,1,-1,1,3,-1,1,1,3,-1,1,-1,3,1,1,-1,1,-1,3,1],
    'total_status': [-1.0,-2.0,0.5,-1.0,-0.5,-2.5,-1.0,-2.0,0.0,1.0,-2.5,0.5,-0.5,2.5,-1.5,-0.5,-2.0,0.0,0.5,1.5,-2.5,0.5,-2.0,0.5,0.0]
}

# Приложение 6: КРС
# БСС, Тревожность, Конфликтность, Чувство неполноценности, Враждебность
krs_zpr = {
    'BSS': [0,1,1,1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,1,0,0,0,1,0,0],
    'anxiety': [2,3,3,2,2,2,2,3,2,2,3,3,3,3,2,2,2,2,2,2,2,2,3,2,2],
    'conflict': [2,2,2,2,1,2,1,1,1,2,2,1,1,1,2,1,2,2,1,2,2,1,1,1,2],
    'inferiority': [0,1,1,1,0,0,0,0,0,0,1,1,0,1,1,1,0,1,0,1,1,0,0,0,1],
    'hostility': [1,0,1,0,1,1,1,0,1,0,1,0,1,1,1,0,0,1,0,1,0,0,0,0,1]
}

krs_norm = {
    'BSS': [1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,0],
    'anxiety': [1,0,1,1,1,2,1,0,1,1,2,1,1,0,1,1,2,1,1,0,1,1,1,2,1],
    'conflict': [2,2,1,1,1,2,1,2,1,2,1,2,1,1,1,1,1,1,1,2,2,1,1,2,2],
    'inferiority': [1,1,0,1,1,0,0,0,1,1,1,0,1,0,0,0,1,0,1,0,1,0,1,0,1],
    'hostility': [1,0,0,0,0,1,0,0,1,1,1,1,0,1,1,1,0,1,0,1,0,1,0,0,0]
}

# Незаконченные предложения (по 11 шкалам)
# 1-Мама, 2-Отец, 3-Братья/сестры, 4-Семья, 5-Ровесники,
# 6-Учителя/школа, 7-Люди, 8-Способности, 9-Негатив, 10-Мечты, 11-Болезнь
nezakon_norm = {
    'mama': [2,1,2,1,2,0,1,2,1,2,2,2,1,1,1,2,1,2,0,2,1,2,1,2,1],
    'father': [1,2,2,0,1,2,1,2,0,1,2,1,1,0,2,1,2,0,1,2,1,2,0,1,2],
    'siblings': [2,0,1,-1,2,1,0,1,2,0,1,2,0,1,-1,2,0,1,2,0,1,2,-1,1,0],
    'family': [2,1,2,1,2,1,1,2,1,2,1,2,1,0,1,2,1,2,1,2,1,2,1,2,1],
    'peers': [1,2,1,2,0,1,2,1,2,1,0,1,2,1,2,0,1,2,1,2,0,1,2,1,2],
    'school': [2,1,0,1,2,2,0,1,1,2,1,0,1,2,1,1,2,0,1,2,1,0,1,2,1],
    'people': [0,1,-1,1,0,1,0,1,-1,0,1,0,1,-1,0,1,0,1,-1,0,1,0,1,-1,0],
    'abilities': [1,0,2,1,2,1,1,2,1,0,1,2,0,1,1,2,0,1,2,1,0,1,2,1,0],
    'negative': [-1.5,-2,-1,-1.5,-2,-1.5,-2,-1,-1.5,-1,-2,-1.5,-2,-1,-1.5,-1,-2,-1,-1.5,-1,-2,-1.5,-2,-1,-1.5],
    'dreams': [2,1,2,1,2,1,2,1,2,1,2,2,1,1,2,1,2,1,2,2,2,2,1,1,1],
    'illness': [-1.5,-1.5,-2,-1.5,-1,-2,-1.5,-2,-1.5,-2,-1.5,-1,-1.5,-2,-1.5,-1,-1.5,-2,-1.5,-1,-1.5,-2,-1.5,-2,-1.5]
}

nezakon_zpr = {
    'mama': [1,2,1,2,0,1,2,1,2,0,1,2,1,2,0,1,2,1,2,0,1,2,1,2,0],
    'father': [0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,-1,0,0,-1,-1,-1,0,0,0],
    'siblings': [1,1,0,-1,1,0,-1,1,1,0,-1,1,0,1,-1,-1,0,1,1,1,0,1,-1,1,0],
    'family': [1,0,1,0,1,0,1,0,1,1,0,0,1,0,1,1,1,0,0,0,1,0,1,0,1],
    'peers': [0,1,-1,0,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0],
    'school': [0,1,1,0,1,1,1,0,0,1,0,0,1,0,1,1,1,0,0,0,0,1,1,0,1],
    'people': [0,0,-1,1,-1,0,-1,-1,-1,0,0,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1],
    'abilities': [0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,1,-1,0,-1,-1,-1,0,-1,0,-1,0,-1],
    'negative': [-1.5,-2,-2,-1.5,-2,-1.5,-1,-1,-1.5,-2,-1.5,-2,-1,-1.5,-2,-1.5,-2,-1,-1.5,-2,-1.5,-2,-1,-1.5,-2],
    'dreams': [1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1],
    'illness': [0,0.5,0,-0.5,0,0,0.5,-0.5,0,0,0,0.5,-0.5,0,0,0.5,-0.5,0,-0.5,0.5,0.5,0,0,0,-0.5]
}

# =============================================================================
# АНАЛИЗ МЕТОДИК НА СООТВЕТСТВИЕ
# =============================================================================

print("="*80)
print("АНАЛИЗ СООТВЕТСТВИЯ ДАННЫХ МЕТОДИКАМ")
print("="*80)

# 1. ЭМОЦИОНАЛЬНЫЕ ЛИЦА (Семаго)
print("\n" + "="*80)
print("1. МЕТОДИКА 'ЭМОЦИОНАЛЬНЫЕ ЛИЦА' (Н.Я. Семаго)")
print("="*80)

print("""
ПРОБЛЕМА: По методике Семаго используется 17 изображений (3 схемы + 14 фото).
- АО (Адекватность опознания) - должен быть процентом правильных ответов
- ЯЭО, УД, ГВ - КАЧЕСТВЕННЫЕ показатели (высокий/средний/низкий)

В данных все показатели представлены числами 5-9, что НЕ СООТВЕТСТВУЕТ методике.
""")

print("Текущие данные:")
print(f"  Норма АО: {np.mean(emolica_norm['AO']):.1f} ± {np.std(emolica_norm['AO']):.2f}")
print(f"  ЗПР АО:   {np.mean(emolica_zpr['AO']):.1f} ± {np.std(emolica_zpr['AO']):.2f}")

print("""
ВЕРДИКТ: ❌ КРИТИЧЕСКАЯ ОШИБКА
- Шкалы ЯЭО, УД, ГВ не должны быть числовыми
- АО должен отражать количество правильных опознаний из 17 (или %)
- Для детей 9-10 лет норма АО должна быть 85-90%+ (14-15 из 17)
""")

# 2. ЭМОЦИОНАЛЬНАЯ ПИКТОГРАММА
print("\n" + "="*80)
print("2. МЕТОДИКА 'ЭМОЦИОНАЛЬНАЯ ПИКТОГРАММА' (М.А. Кузьмищева)")
print("="*80)

print("""
ИНФОРМАЦИЯ: Методика основана на опосредованном запоминании эмоций.
Расшифровка шкал (предположительно):
- РЕ - Распознавание эмоций
- В - Воспроизведение/Вербализация
- УОЗ - Уровень опосредованного запоминания
- ЭО - Эмоциональный образ
- ФЭН - ?

Без доступа к оригинальной методике сложно оценить корректность диапазонов.
""")

print("Анализ различий между группами:")
for key in piktogramma_norm.keys():
    norm_mean = np.mean(piktogramma_norm[key])
    zpr_mean = np.mean(piktogramma_zpr[key])
    u_stat, p_val = stats.mannwhitneyu(piktogramma_norm[key], piktogramma_zpr[key], alternative='two-sided')
    sig = "***" if p_val < 0.001 else ("**" if p_val < 0.01 else ("*" if p_val < 0.05 else ""))
    print(f"  {key}: Норма={norm_mean:.1f}, ЗПР={zpr_mean:.1f}, U={u_stat:.0f}, p={p_val:.4f} {sig}")

print("""
ВЕРДИКТ: ⚠️ ПОТЕНЦИАЛЬНАЯ ПРОБЛЕМА
- Шкала 'В' (Воспроизведение) показывает ОГРОМНОЕ различие (p<0.001)
- Все дети с ЗПР имеют низкие значения (6-8), все дети с нормой высокие (10-12)
- Это выглядит НЕРЕАЛИСТИЧНО - слишком идеальное разделение групп
- По литературе различия должны быть умеренными, не абсолютными
""")

# 3. НЕЗАКОНЧЕННЫЕ ПРЕДЛОЖЕНИЯ
print("\n" + "="*80)
print("3. МЕТОДИКА 'НЕЗАКОНЧЕННЫЕ ПРЕДЛОЖЕНИЯ' (Сакс-Леви/Михал)")
print("="*80)

print("""
ПРОВЕРКА ДИАПАЗОНОВ:
- Шкалы с 2 предложениями: диапазон от -4 до +4
- Шкалы с 3 предложениями: диапазон от -6 до +6
- Шкалы с 1 предложением: диапазон от -2 до +2

Если используются СРЕДНИЕ значения (а не суммы), то диапазон -2 до +2.
""")

# Проверка на дробные значения
print("Проверка дробных значений:")
for key in ['negative', 'illness']:
    norm_vals = nezakon_norm[key]
    zpr_vals = nezakon_zpr[key]
    has_fraction_norm = any(v != int(v) for v in norm_vals)
    has_fraction_zpr = any(v != int(v) for v in zpr_vals)
    print(f"  {key}: Норма имеет дроби: {has_fraction_norm}, ЗПР имеет дроби: {has_fraction_zpr}")

print("""
ВЕРДИКТ: ✅ ДОПУСТИМО
- Дробные значения (-1.5, 0.5) указывают на использование средних
- Диапазоны соответствуют методике
""")

# 4. КРС
print("\n" + "="*80)
print("4. МЕТОДИКА 'КИНЕТИЧЕСКИЙ РИСУНОК СЕМЬИ' (Бернс, Кауфман)")
print("="*80)

print("""
ПРОВЕРКА ДИАПАЗОНОВ по симптомокомплексам:
- БСС: макс. 1.5 балла
- Тревожность: макс. 3 балла
- Конфликтность: макс. 3 балла
- Чувство неполноценности: макс. 1.6 балла
- Враждебность: макс. 1.3 балла
""")

print("Текущие диапазоны в данных:")
for key, name in [('BSS', 'БСС'), ('anxiety', 'Тревожность'),
                   ('conflict', 'Конфликтность'), ('inferiority', 'Неполноценность'),
                   ('hostility', 'Враждебность')]:
    max_zpr = max(krs_zpr[key])
    max_norm = max(krs_norm[key])
    print(f"  {name}: ЗПР max={max_zpr}, Норма max={max_norm}")

print("""
ВЕРДИКТ: ⚠️ ПРОБЛЕМА
- Тревожность в ЗПР достигает 3 баллов - это МАКСИМУМ по методике
- По методике баллы дробные (0.1, 0.2), а здесь целые (1, 2, 3)
- Вероятно, используется упрощенная шкала или другая система подсчета
- Это допустимо, но следует указать в методологии
""")

# 5. СОЦИОМЕТРИЯ
print("\n" + "="*80)
print("5. МЕТОДИКА 'СОЦИОМЕТРИЯ' (Морено)")
print("="*80)

print("""
ПРОВЕРКА РАСЧЕТА СТАТУСОВ:
Формула: Статус = (R+ - R-) / (N-1), где N=25

Проверяю первые 5 испытуемых ЗПР:
""")

for i in range(5):
    lich_calc = sociometry_zpr['lich_plus'][i] - sociometry_zpr['lich_minus'][i]
    lich_data = sociometry_zpr['lich_status'][i]
    pozn_calc = sociometry_zpr['pozn_plus'][i] - sociometry_zpr['pozn_minus'][i]
    pozn_data = sociometry_zpr['pozn_status'][i]
    total_calc = (lich_calc + pozn_calc) / 2
    total_data = sociometry_zpr['total_status'][i]

    print(f"  E{i+1}: Лич. статус: расчет={lich_calc}, данные={lich_data}, "
          f"Общий: расчет={total_calc:.1f}, данные={total_data}")

print("""
ВЕРДИКТ: ⚠️ ОТКЛОНЕНИЕ ОТ КЛАССИКИ
- Статусы рассчитаны как простая разность (R+ - R-), без деления на (N-1)
- Это ДОПУСТИМЫЙ вариант, но не классический индекс Морено
- Общий статус = среднее двух статусов - корректно
""")

print("\n" + "="*80)
print("ИТОГОВАЯ СВОДКА ПРОБЛЕМ")
print("="*80)

print("""
КРИТИЧЕСКИЕ ОШИБКИ (требуют исправления):
1. ❌ Эмоциональные лица: ЯЭО, УД, ГВ не должны быть числовыми
2. ❌ Эмоциональные лица: АО слишком низкий для 9-10 летних детей
3. ❌ Эмоциональная пиктограмма: шкала 'В' нереалистично разделяет группы

ДОПУСТИМЫЕ ОТКЛОНЕНИЯ (можно оставить с пояснением):
1. ⚠️ КРС: целые баллы вместо дробных (упрощенная шкала)
2. ⚠️ Социометрия: простая разность вместо индекса

КОРРЕКТНЫЕ ДАННЫЕ:
1. ✅ Анкета педагогу
2. ✅ Незаконченные предложения
""")
