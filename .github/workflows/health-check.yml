name: Health Check & Auto-Restart

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç + —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
on:
  schedule:
    - cron: '*/10 * * * *'  # –ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check services health
        uses: appleboy/ssh-action@v1.0.3
        id: health
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "=== Health Check at $(date) ==="

            ISSUES=""
            RESTARTED=""

            # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–æ—Ç–∞
            echo "Checking saloon-bot service..."
            if ! systemctl is-active --quiet saloon-bot; then
              echo "‚ö†Ô∏è Bot service is DOWN! Restarting..."
              fuser -k 8000/tcp 2>/dev/null || true
              sleep 2
              systemctl restart saloon-bot
              sleep 5
              if systemctl is-active --quiet saloon-bot; then
                RESTARTED="$RESTARTED bot"
                echo "‚úÖ Bot restarted successfully"
              else
                ISSUES="$ISSUES bot_failed"
                echo "‚ùå Bot failed to restart"
              fi
            else
              echo "‚úÖ Bot is running"
            fi

            # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º Nginx
            echo "Checking nginx..."
            if ! systemctl is-active --quiet nginx; then
              echo "‚ö†Ô∏è Nginx is DOWN! Restarting..."
              systemctl restart nginx
              if systemctl is-active --quiet nginx; then
                RESTARTED="$RESTARTED nginx"
                echo "‚úÖ Nginx restarted"
              else
                ISSUES="$ISSUES nginx_failed"
              fi
            else
              echo "‚úÖ Nginx is running"
            fi

            # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º PostgreSQL
            echo "Checking PostgreSQL..."
            if ! systemctl is-active --quiet postgresql; then
              echo "‚ö†Ô∏è PostgreSQL is DOWN! Restarting..."
              systemctl restart postgresql
              if systemctl is-active --quiet postgresql; then
                RESTARTED="$RESTARTED postgresql"
              else
                ISSUES="$ISSUES postgresql_failed"
              fi
            else
              echo "‚úÖ PostgreSQL is running"
            fi

            # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º Redis
            echo "Checking Redis..."
            if ! systemctl is-active --quiet redis-server 2>/dev/null && ! systemctl is-active --quiet redis 2>/dev/null; then
              echo "‚ö†Ô∏è Redis might be down, checking..."
              if command -v redis-cli &> /dev/null && ! redis-cli ping &> /dev/null; then
                ISSUES="$ISSUES redis_down"
              fi
            else
              echo "‚úÖ Redis is running"
            fi

            # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏—Å–∫ –∏ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò —á–∏—Å—Ç–∏–º –µ—Å–ª–∏ > 80%
            echo "Checking disk space..."
            DISK_USAGE=$(df -h / | tail -1 | awk '{print $5}' | tr -d '%')
            if [ "$DISK_USAGE" -gt 80 ]; then
              echo "‚ö†Ô∏è Disk usage is ${DISK_USAGE}% ‚Äî –ê–í–¢–û-–û–ß–ò–°–¢–ö–ê..."

              # –ß–∏—Å—Ç–∏–º –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 3 –¥–Ω–µ–π
              journalctl --vacuum-time=3d 2>/dev/null || true

              # –ß–∏—Å—Ç–∏–º apt –∫—ç—à
              apt-get clean 2>/dev/null || true

              # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (> 7 –¥–Ω–µ–π)
              find /root/backups -name '*.sql.gz' -mtime +7 -delete 2>/dev/null || true

              # –ß–∏—Å—Ç–∏–º tmp
              find /tmp -type f -mtime +1 -delete 2>/dev/null || true

              # –ß–∏—Å—Ç–∏–º pip –∫—ç—à
              pip cache purge 2>/dev/null || true

              # –ß–∏—Å—Ç–∏–º npm –∫—ç—à
              npm cache clean --force 2>/dev/null || true

              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
              DISK_AFTER=$(df -h / | tail -1 | awk '{print $5}' | tr -d '%')
              echo "‚úÖ Disk cleaned: ${DISK_USAGE}% ‚Üí ${DISK_AFTER}%"
              DISK_USAGE=$DISK_AFTER
              RESTARTED="$RESTARTED disk_cleaned"

              # –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë > 90% ‚Äî —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞
              if [ "$DISK_USAGE" -gt 90 ]; then
                ISSUES="$ISSUES disk_critical_${DISK_USAGE}%"
              fi
            else
              echo "‚úÖ Disk usage: ${DISK_USAGE}%"
            fi

            # 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º RAM –∏ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –µ—Å–ª–∏ > 85%
            echo "Checking memory..."
            MEM_USAGE=$(free | grep Mem | awk '{printf("%.0f", $3/$2 * 100)}')
            if [ "$MEM_USAGE" -gt 85 ]; then
              echo "‚ö†Ô∏è Memory usage is ${MEM_USAGE}% ‚Äî –ê–í–¢–û-–ü–ï–†–ï–ó–ê–ü–£–°–ö –±–æ—Ç–∞..."

              # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –ø–∞–º—è—Ç—å
              fuser -k 8000/tcp 2>/dev/null || true
              sleep 2
              systemctl restart saloon-bot
              sleep 5

              # –û—á–∏—â–∞–µ–º –∫—ç—à–∏ –ø–∞–º—è—Ç–∏
              sync && echo 3 > /proc/sys/vm/drop_caches 2>/dev/null || true

              MEM_AFTER=$(free | grep Mem | awk '{printf("%.0f", $3/$2 * 100)}')
              echo "‚úÖ Memory freed: ${MEM_USAGE}% ‚Üí ${MEM_AFTER}%"
              RESTARTED="$RESTARTED memory_cleaned"

              # –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë > 95% ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞
              if [ "$MEM_AFTER" -gt 95 ]; then
                ISSUES="$ISSUES memory_critical_${MEM_AFTER}%"
              fi
            else
              echo "‚úÖ Memory usage: ${MEM_USAGE}%"
            fi

            # 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É
            echo "Checking bot API..."
            if ! curl -s --max-time 5 http://localhost:8000/health > /dev/null 2>&1; then
              # –ü–æ–ø—Ä–æ–±—É–µ–º –±–∞–∑–æ–≤—ã–π endpoint
              if ! curl -s --max-time 5 http://localhost:8000/ > /dev/null 2>&1; then
                echo "‚ö†Ô∏è Bot API not responding on port 8000"
                # –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ ISSUES –µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç - –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å /health endpoint
              fi
            else
              echo "‚úÖ Bot API responding"
            fi

            echo "=== Health Check Complete ==="
            echo "ISSUES: $ISSUES"
            echo "RESTARTED: $RESTARTED"
            echo "DISK_USAGE: $DISK_USAGE"
            echo "MEM_USAGE: $MEM_USAGE"

            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤
            echo "ISSUES=$ISSUES" >> $GITHUB_OUTPUT 2>/dev/null || echo "ISSUES=$ISSUES"
            echo "RESTARTED=$RESTARTED" >> $GITHUB_OUTPUT 2>/dev/null || echo "RESTARTED=$RESTARTED"
            echo "DISK_USAGE=$DISK_USAGE" >> $GITHUB_OUTPUT 2>/dev/null || echo "DISK_USAGE=$DISK_USAGE"
            echo "MEM_USAGE=$MEM_USAGE" >> $GITHUB_OUTPUT 2>/dev/null || echo "MEM_USAGE=$MEM_USAGE"

            # –í—ã—Ö–æ–¥–∏–º —Å –æ—à–∏–±–∫–æ–π –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Ä–µ—à—ë–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
            if [ -n "$ISSUES" ]; then
              exit 1
            fi

      - name: Notify Telegram (Issues Found)
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_NOTIFY_CHAT_ID || '872379852' }}
          token: ${{ secrets.BOT_TOKEN }}
          format: markdown
          message: |
            üö® *Health Check: –ü—Ä–æ–±–ª–µ–º—ã!*

            ‚è∞ –í—Ä–µ–º—è: ${{ github.event.schedule && '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞' || '–†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞' }}

            –ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ä–≤–µ—Ä - –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
            - –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞
            - –î–∏—Å–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω >85%
            - –ü–∞–º—è—Ç—å >90%

            üîó [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      # –£–≤–µ–¥–æ–º–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ã–ª–∏ —Ä–µ—Å—Ç–∞—Ä—Ç—ã (–Ω–µ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç)
      - name: Notify Telegram (Auto-Restart)
        if: success() && contains(steps.health.outputs.RESTARTED, ' ')
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_NOTIFY_CHAT_ID || '872379852' }}
          token: ${{ secrets.BOT_TOKEN }}
          format: markdown
          message: |
            üîÑ *Auto-Restart –≤—ã–ø–æ–ª–Ω–µ–Ω!*

            –°–µ—Ä–≤–∏—Å—ã –±—ã–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
            –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç!
