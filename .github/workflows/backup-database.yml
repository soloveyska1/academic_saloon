name: Database Backup to Yandex Disk

# –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±—ç–∫–∞–ø –ë–î + —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
on:
  schedule:
    - cron: '0 4 * * *'  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 4:00 UTC (7:00 –ú–°–ö)
  workflow_dispatch:
    inputs:
      notify:
        description: 'Send Telegram notification'
        required: false
        default: 'true'

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Create backup and upload to Yandex Disk
        uses: appleboy/ssh-action@v1.0.3
        id: backup
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            BACKUP_DIR="/root/backups"
            DATE=$(date +%Y-%m-%d_%H-%M-%S)
            BACKUP_FILE="academic_saloon_${DATE}.sql.gz"
            YADISK_FOLDER="Academic_Saloon_Backups"

            echo "=== Starting database backup at $(date) ==="

            # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–æ–≤
            mkdir -p $BACKUP_DIR

            # –°–æ–∑–¥–∞—ë–º –¥–∞–º–ø –ë–î –∏ —Å–∂–∏–º–∞–µ–º
            echo "Creating PostgreSQL dump..."
            cd ~/academic_saloon

            # –ß–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ —á–µ–º source)
            export POSTGRES_USER=$(grep -E '^POSTGRES_USER=' .env | cut -d'=' -f2-)
            export POSTGRES_PASSWORD=$(grep -E '^POSTGRES_PASSWORD=' .env | cut -d'=' -f2-)
            export POSTGRES_DB=$(grep -E '^POSTGRES_DB=' .env | cut -d'=' -f2-)
            export POSTGRES_HOST=$(grep -E '^POSTGRES_HOST=' .env | cut -d'=' -f2-)
            export POSTGRES_PORT=$(grep -E '^POSTGRES_PORT=' .env | cut -d'=' -f2-)
            export YANDEX_DISK_TOKEN=$(grep -E '^YANDEX_DISK_TOKEN=' .env | cut -d'=' -f2-)

            PGPASSWORD=$POSTGRES_PASSWORD pg_dump -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER $POSTGRES_DB | gzip > $BACKUP_DIR/$BACKUP_FILE

            BACKUP_SIZE=$(ls -lh $BACKUP_DIR/$BACKUP_FILE | awk '{print $5}')
            echo "Backup created: $BACKUP_FILE ($BACKUP_SIZE)"

            # –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫
            echo "Uploading to Yandex Disk..."

            # –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–µ (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
            curl -s -X PUT \
              -H "Authorization: OAuth $YANDEX_DISK_TOKEN" \
              "https://cloud-api.yandex.net/v1/disk/resources?path=/$YADISK_FOLDER" || true

            # –ü–æ–ª—É—á–∞–µ–º URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
            UPLOAD_URL=$(curl -s -X GET \
              -H "Authorization: OAuth $YANDEX_DISK_TOKEN" \
              "https://cloud-api.yandex.net/v1/disk/resources/upload?path=/$YADISK_FOLDER/$BACKUP_FILE&overwrite=true" \
              | grep -o '"href":"[^"]*"' | head -1 | cut -d'"' -f4)

            if [ -z "$UPLOAD_URL" ]; then
              echo "ERROR: Failed to get upload URL"
              exit 1
            fi

            # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
            curl -s -T $BACKUP_DIR/$BACKUP_FILE "$UPLOAD_URL"

            echo "‚úÖ Backup uploaded to Yandex Disk: /$YADISK_FOLDER/$BACKUP_FILE"

            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –±—ç–∫–∞–ø—ã (—Å—Ç–∞—Ä—à–µ 3 –¥–Ω–µ–π)
            find $BACKUP_DIR -name "academic_saloon_*.sql.gz" -mtime +3 -delete
            echo "Old local backups cleaned"

            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã –Ω–∞ –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫–µ (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7)
            echo "Cleaning old Yandex Disk backups..."
            OLD_BACKUPS=$(curl -s -X GET \
              -H "Authorization: OAuth $YANDEX_DISK_TOKEN" \
              "https://cloud-api.yandex.net/v1/disk/resources?path=/$YADISK_FOLDER&limit=100&sort=-created" \
              | grep -o '"name":"academic_saloon_[^"]*"' | cut -d'"' -f4 | tail -n +8)

            for old_file in $OLD_BACKUPS; do
              echo "Deleting old backup: $old_file"
              curl -s -X DELETE \
                -H "Authorization: OAuth $YANDEX_DISK_TOKEN" \
                "https://cloud-api.yandex.net/v1/disk/resources?path=/$YADISK_FOLDER/$old_file&permanently=true"
            done

            echo "=== Backup completed at $(date) ==="
            echo "BACKUP_FILE=$BACKUP_FILE" >> /tmp/backup_result
            echo "BACKUP_SIZE=$BACKUP_SIZE" >> /tmp/backup_result

      - name: Notify Telegram (Success)
        if: success() && (github.event.inputs.notify != 'false')
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_NOTIFY_CHAT_ID || '872379852' }}
          token: ${{ secrets.BOT_TOKEN }}
          format: markdown
          message: |
            üíæ *Backup –ë–î –≤—ã–ø–æ–ª–Ω–µ–Ω!*

            üìÖ –í—Ä–µ–º—è: ${{ github.event.schedule && '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π (4:00 –ú–°–ö)' || '–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫' }}
            üìÅ –§–∞–π–ª: `academic_saloon_${{ github.run_id }}.sql.gz`
            ‚òÅÔ∏è –°–æ—Ö—Ä–∞–Ω—ë–Ω –≤: –Ø–Ω–¥–µ–∫—Å –î–∏—Å–∫

            ‚úÖ –•—Ä–∞–Ω–∏—Ç—Å—è 7 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –±—ç–∫–∞–ø–æ–≤

      - name: Notify Telegram (Failure)
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_NOTIFY_CHAT_ID || '872379852' }}
          token: ${{ secrets.BOT_TOKEN }}
          format: markdown
          message: |
            ‚ùå *Backup –ë–î –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è!*

            ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏:
            üîó [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
