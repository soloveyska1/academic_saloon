name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Deploy via SSH
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # Exit on any error

            echo "=== Starting deploy at $(date) ==="

            # Navigate to project directory
            cd ~/academic_saloon || git clone https://github.com/soloveyska1/academic_saloon.git ~/academic_saloon
            cd ~/academic_saloon

            echo "Current commit: $(git rev-parse --short HEAD)"

            # Update code from GitHub
            git fetch --all --prune
            git checkout main
            git reset --hard origin/main

            echo "Updated to commit: $(git rev-parse --short HEAD)"

            # ============================================
            # BACKEND: Python dependencies
            # ============================================
            echo "=== Installing Python dependencies ==="
            cd ~/academic_saloon

            # Activate virtual environment if exists, or create it
            if [ ! -d "venv" ]; then
                python3 -m venv venv
            fi
            source venv/bin/activate

            # Install/update dependencies
            pip install --upgrade pip
            pip install -r requirements.txt --quiet

            echo "‚úÖ Python dependencies installed"

            # ============================================
            # DATABASE: Run migrations
            # ============================================
            echo "=== Running database migrations ==="
            cd ~/academic_saloon
            source venv/bin/activate

            # Run alembic migrations (if any pending)
            alembic upgrade head 2>/dev/null || echo "No migrations or alembic not configured"

            echo "‚úÖ Migrations complete"

            # ============================================
            # BACKEND: Restart the bot service
            # ============================================
            echo "=== Restarting bot service ==="

            # 1. Stop the service
            echo "Stopping systemd service..."
            systemctl stop saloon-bot || true
            
            # 2. Kill loop (Try 5 times to clear port 8000)
            echo "Killing processes on port 8000..."
            for i in {1..5}; do
                if fuser 8000/tcp >/dev/null 2>&1; then
                    fuser -k -9 8000/tcp >/dev/null 2>&1 || true
                    echo "  Killed process on port 8000 (attempt $i)"
                    sleep 2
                else
                    echo "  Port 8000 is free."
                    break
                fi
            done
            
            # 3. Final Verification and Wait
            if fuser 8000/tcp >/dev/null 2>&1; then
                echo "‚ùå CRITICAL: Port 8000 still in use. Force killing again..."
                fuser -k -9 8000/tcp || true
            fi
            
            # FORCE WAIT so socket can clear TIME_WAIT
            echo "Waiting 10s for socket cleanup..."
            sleep 10

            # 4. Start systemd service
            echo "Starting systemd service..."
            systemctl start saloon-bot
            sleep 5

            # Verify bot is running
            if systemctl is-active --quiet saloon-bot; then
                echo "‚úÖ Bot service is running"
            else
                echo "‚ùå Bot service failed to start"
                journalctl -u saloon-bot --no-pager -n 20
                exit 1
            fi

            # ============================================
            # FRONTEND: Build and deploy mini-app
            # ============================================
            echo "=== Building mini-app ==="
            cd ~/academic_saloon/mini-app

            # Install dependencies and build
            npm ci --prefer-offline
            npm run build

            # Deploy to web directory
            echo "=== Deploying mini-app to /var/www ==="
            rm -rf /var/www/academic_saloon/dist/*
            cp -r dist/* /var/www/academic_saloon/dist/
            chown -R www-data:www-data /var/www/academic_saloon/dist/

            # Reload nginx to clear any cache
            nginx -t && systemctl reload nginx

            echo "‚úÖ Mini-app deployed: $(ls /var/www/academic_saloon/dist/assets/index-*.js)"

            echo "=== Deploy completed successfully at $(date) ==="

      # ============================================
      # TELEGRAM NOTIFICATIONS
      # ============================================
      - name: Notify Telegram (Success)
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_NOTIFY_CHAT_ID || '872379852' }}
          token: ${{ secrets.BOT_TOKEN }}
          format: markdown
          message: |
            ‚úÖ *Deploy —É—Å–ø–µ—à–µ–Ω!*

            üì¶ –ö–æ–º–º–∏—Ç: `${{ github.sha }}`
            üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}
            üìù –°–æ–æ–±—â–µ–Ω–∏–µ: ${{ github.event.head_commit.message }}

            üîó [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–º–º–∏—Ç](${{ github.event.head_commit.url }})

      - name: Notify Telegram (Failure)
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_NOTIFY_CHAT_ID || '872379852' }}
          token: ${{ secrets.BOT_TOKEN }}
          format: markdown
          message: |
            ‚ùå *Deploy –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è!*

            üì¶ –ö–æ–º–º–∏—Ç: `${{ github.sha }}`
            üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}
            üìù –°–æ–æ–±—â–µ–Ω–∏–µ: ${{ github.event.head_commit.message }}

            üîó [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
