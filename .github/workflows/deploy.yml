name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Deploy via SSH
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # Exit on any error

            echo "=== Starting deploy at $(date) ==="

            # Navigate to project directory
            cd ~/academic_saloon || git clone https://github.com/soloveyska1/academic_saloon.git ~/academic_saloon
            cd ~/academic_saloon

            echo "Current commit: $(git rev-parse --short HEAD)"

            # Update code from GitHub
            git fetch --all --prune
            git checkout main
            git reset --hard origin/main

            echo "Updated to commit: $(git rev-parse --short HEAD)"

            # ============================================
            # BACKEND: Restart the bot service
            # ============================================
            echo "=== Restarting bot service ==="

            # Kill any orphan python processes on port 8000
            fuser -k 8000/tcp 2>/dev/null || true
            sleep 2

            # Restart systemd service
            systemctl restart saloon-bot
            sleep 3

            # Verify bot is running
            if systemctl is-active --quiet saloon-bot; then
                echo "‚úÖ Bot service is running"
            else
                echo "‚ùå Bot service failed to start"
                journalctl -u saloon-bot --no-pager -n 20
                exit 1
            fi

            # ============================================
            # FRONTEND: Build and deploy mini-app
            # ============================================
            echo "=== Building mini-app ==="
            cd ~/academic_saloon/mini-app

            # Install dependencies and build
            npm ci --prefer-offline
            npm run build

            # Deploy to web directory
            echo "=== Deploying mini-app to /var/www ==="
            rm -rf /var/www/academic_saloon/dist/*
            cp -r dist/* /var/www/academic_saloon/dist/
            chown -R www-data:www-data /var/www/academic_saloon/dist/

            # Reload nginx to clear any cache
            nginx -t && systemctl reload nginx

            echo "‚úÖ Mini-app deployed: $(ls /var/www/academic_saloon/dist/assets/index-*.js)"

            echo "=== Deploy completed successfully at $(date) ==="

      # ============================================
      # TELEGRAM NOTIFICATIONS
      # ============================================
      - name: Notify Telegram (Success)
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_NOTIFY_CHAT_ID || '872379852' }}
          token: ${{ secrets.BOT_TOKEN }}
          format: markdown
          message: |
            ‚úÖ *Deploy —É—Å–ø–µ—à–µ–Ω!*

            üì¶ –ö–æ–º–º–∏—Ç: `${{ github.sha }}`
            üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}
            üìù –°–æ–æ–±—â–µ–Ω–∏–µ: ${{ github.event.head_commit.message }}

            üîó [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–º–º–∏—Ç](${{ github.event.head_commit.url }})

      - name: Notify Telegram (Failure)
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_NOTIFY_CHAT_ID || '872379852' }}
          token: ${{ secrets.BOT_TOKEN }}
          format: markdown
          message: |
            ‚ùå *Deploy –ø—Ä–æ–≤–∞–ª–∏–ª—Å—è!*

            üì¶ –ö–æ–º–º–∏—Ç: `${{ github.sha }}`
            üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}
            üìù –°–æ–æ–±—â–µ–Ω–∏–µ: ${{ github.event.head_commit.message }}

            üîó [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
