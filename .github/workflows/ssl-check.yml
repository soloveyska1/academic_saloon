name: SSL Certificate Check

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð° Ñ€Ð°Ð· Ð² Ð½ÐµÐ´ÐµÐ»ÑŽ
on:
  schedule:
    - cron: '0 9 * * 1'  # ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº Ð² 9:00 UTC (12:00 ÐœÐ¡Ðš)
  workflow_dispatch:

jobs:
  check-ssl:
    runs-on: ubuntu-latest
    steps:
      - name: Check SSL certificate expiry
        id: ssl
        run: |
          DOMAIN="academic-saloon.duckdns.org"

          echo "Checking SSL for $DOMAIN..."

          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ñ‚Ñƒ Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°
          EXPIRY_DATE=$(echo | openssl s_client -servername $DOMAIN -connect $DOMAIN:443 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)

          if [ -z "$EXPIRY_DATE" ]; then
            echo "ERROR: Could not get certificate info"
            echo "status=error" >> $GITHUB_OUTPUT
            exit 1
          fi

          # ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð² timestamp
          EXPIRY_TS=$(date -d "$EXPIRY_DATE" +%s)
          NOW_TS=$(date +%s)
          DAYS_LEFT=$(( (EXPIRY_TS - NOW_TS) / 86400 ))

          echo "Certificate expires: $EXPIRY_DATE"
          echo "Days left: $DAYS_LEFT"

          echo "expiry_date=$EXPIRY_DATE" >> $GITHUB_OUTPUT
          echo "days_left=$DAYS_LEFT" >> $GITHUB_OUTPUT

          if [ $DAYS_LEFT -lt 14 ]; then
            echo "status=critical" >> $GITHUB_OUTPUT
          elif [ $DAYS_LEFT -lt 30 ]; then
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "status=ok" >> $GITHUB_OUTPUT
          fi

      - name: Notify Telegram (Critical - <14 days)
        if: steps.ssl.outputs.status == 'critical'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_NOTIFY_CHAT_ID || '872379852' }}
          token: ${{ secrets.BOT_TOKEN }}
          format: markdown
          message: |
            ðŸš¨ *SSL Ð¡Ð•Ð Ð¢Ð˜Ð¤Ð˜ÐšÐÐ¢ Ð˜Ð¡Ð¢Ð•ÐšÐÐ•Ð¢!*

            âš ï¸ ÐžÑÑ‚Ð°Ð»Ð¾ÑÑŒ Ð´Ð½ÐµÐ¹: *${{ steps.ssl.outputs.days_left }}*
            ðŸ“… Ð”Ð°Ñ‚Ð° Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ: ${{ steps.ssl.outputs.expiry_date }}

            ÐÑƒÐ¶Ð½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚!
            ÐÐ° ÑÐµÑ€Ð²ÐµÑ€Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸: `certbot renew`

      - name: Notify Telegram (Warning - <30 days)
        if: steps.ssl.outputs.status == 'warning'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_NOTIFY_CHAT_ID || '872379852' }}
          token: ${{ secrets.BOT_TOKEN }}
          format: markdown
          message: |
            âš ï¸ *SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ ÑÐºÐ¾Ñ€Ð¾ Ð¸ÑÑ‚ÐµÐºÐ°ÐµÑ‚*

            ðŸ“… ÐžÑÑ‚Ð°Ð»Ð¾ÑÑŒ Ð´Ð½ÐµÐ¹: ${{ steps.ssl.outputs.days_left }}
            ðŸ“… Ð”Ð°Ñ‚Ð° Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ: ${{ steps.ssl.outputs.expiry_date }}

            Certbot Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸, Ð½Ð¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒ.

      - name: Notify Telegram (Error)
        if: steps.ssl.outputs.status == 'error'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_NOTIFY_CHAT_ID || '872379852' }}
          token: ${{ secrets.BOT_TOKEN }}
          format: markdown
          message: |
            âŒ *ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ SSL*

            Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, ÑÐµÑ€Ð²ÐµÑ€ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¸Ð»Ð¸ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ ÑƒÐ¶Ðµ Ð¸ÑÑ‚Ñ‘Ðº.

            ðŸ”— [ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð»Ð¾Ð³Ð¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
