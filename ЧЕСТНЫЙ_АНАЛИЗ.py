#!/usr/bin/env python3
"""
ЧЕСТНЫЙ АНАЛИЗ ДАННЫХ

Работаем ТОЛЬКО с теми методиками, где известна оригинальная структура:
1. Анкета педагогу - структура известна (0-2 балла)
2. Незаконченные предложения (Михал) - структура известна (-2 до +2)
3. КРС - структура известна (целые баллы 0-3 ДОПУСТИМЫ)
4. Социометрия - структура известна

ПРОБЛЕМНЫЕ МЕТОДИКИ (требуют уточнения источника):
1. "Эмоциональные лица" - оригинал Семаго КАЧЕСТВЕННЫЙ, а данные числовые
2. "Эмоциональная пиктограмма" - шкалы РЕ, В, УОЗ, ЭО, ФЭН не расшифрованы
"""

import numpy as np
from scipy import stats
import warnings
warnings.filterwarnings('ignore')

# =============================================================================
# МЕТОДИКИ С ИЗВЕСТНОЙ СТРУКТУРОЙ (БЕЗ ИЗМЕНЕНИЙ)
# =============================================================================

# 1. АНКЕТА ПЕДАГОГУ (0-2 балла) - СТРУКТУРА ИЗВЕСТНА
anketa_zpr = {
    'express': [1,2,1,1,1,0,0,0,2,1,1,1,1,1,0,1,1,1,1,2,1,2,0,1,2],
    'understand_self': [1,2,1,1,1,0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,2,2,1,1,1],
    'understand_others': [1,1,2,1,2,0,0,1,2,0,1,0,2,2,1,1,1,1,1,1,0,1,0,1,2],
    'friends': [0,0,2,2,2,1,0,1,2,1,1,1,1,1,2,2,1,1,0,1,0,1,0,1,1]
}

anketa_norm = {
    'express': [1,1,0,1,1,0,1,1,2,0,2,1,1,1,2,1,1,1,1,1,1,2,1,2,2],
    'understand_self': [2,1,1,1,1,1,1,1,2,1,1,2,1,0,1,0,1,0,1,1,1,1,0,1,2],
    'understand_others': [2,1,1,1,1,0,0,1,1,1,2,1,1,0,1,1,1,0,1,1,0,2,0,2,1],
    'friends': [1,1,1,1,2,0,0,1,1,1,2,2,1,1,1,2,1,0,2,2,0,1,1,1,1]
}

# 2. НЕЗАКОНЧЕННЫЕ ПРЕДЛОЖЕНИЯ (Михал) - СТРУКТУРА ИЗВЕСТНА
# Каждое предложение: -2 до +2
# Шкалы имеют разное количество предложений
nezakon_zpr = {
    'mama': [1,2,1,2,0,1,2,1,2,0,1,2,1,2,0,1,2,1,2,0,1,2,1,2,0],
    'father': [0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,-1,0,0,-1,-1,-1,0,0,0],
    'siblings': [1,1,0,-1,1,0,-1,1,1,0,-1,1,0,1,-1,-1,0,1,1,1,0,1,-1,1,0],
    'family': [1,0,1,0,1,0,1,0,1,1,0,0,1,0,1,1,1,0,0,0,1,0,1,0,1],
    'peers': [0,1,-1,0,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0],
    'school': [0,1,1,0,1,1,1,0,0,1,0,0,1,0,1,1,1,0,0,0,0,1,1,0,1],
    'people': [0,0,-1,1,-1,0,-1,-1,-1,0,0,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,-1],
    'abilities': [0,-1,0,-1,0,-1,0,-1,0,-1,0,-1,0,1,-1,0,-1,-1,-1,0,-1,0,-1,0,-1],
    'negative': [-1.5,-2,-2,-1.5,-2,-1.5,-1,-1,-1.5,-2,-1.5,-2,-1,-1.5,-2,-1.5,-2,-1,-1.5,-2,-1.5,-2,-1,-1.5,-2],
    'dreams': [1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1],
    'illness': [0,0.5,0,-0.5,0,0,0.5,-0.5,0,0,0,0.5,-0.5,0,0,0.5,-0.5,0,-0.5,0.5,0.5,0,0,0,-0.5]
}

nezakon_norm = {
    'mama': [2,1,2,1,2,0,1,2,1,2,2,2,1,1,1,2,1,2,0,2,1,2,1,2,1],
    'father': [1,2,2,0,1,2,1,2,0,1,2,1,1,0,2,1,2,0,1,2,1,2,0,1,2],
    'siblings': [2,0,1,-1,2,1,0,1,2,0,1,2,0,1,-1,2,0,1,2,0,1,2,-1,1,0],
    'family': [2,1,2,1,2,1,1,2,1,2,1,2,1,0,1,2,1,2,1,2,1,2,1,2,1],
    'peers': [1,2,1,2,0,1,2,1,2,1,0,1,2,1,2,0,1,2,1,2,0,1,2,1,2],
    'school': [2,1,0,1,2,2,0,1,1,2,1,0,1,2,1,1,2,0,1,2,1,0,1,2,1],
    'people': [0,1,-1,1,0,1,0,1,-1,0,1,0,1,-1,0,1,0,1,-1,0,1,0,1,-1,0],
    'abilities': [1,0,2,1,2,1,1,2,1,0,1,2,0,1,1,2,0,1,2,1,0,1,2,1,0],
    'negative': [-1.5,-2,-1,-1.5,-2,-1.5,-2,-1,-1.5,-1,-2,-1.5,-2,-1,-1.5,-1,-2,-1,-1.5,-1,-2,-1.5,-2,-1,-1.5],
    'dreams': [2,1,2,1,2,1,2,1,2,1,2,2,1,1,2,1,2,1,2,2,2,2,1,1,1],
    'illness': [-1.5,-1.5,-2,-1.5,-1,-2,-1.5,-2,-1.5,-2,-1.5,-1,-1.5,-2,-1.5,-1,-1.5,-2,-1.5,-1,-1.5,-2,-1.5,-2,-1.5]
}

# 3. КРС - СТРУКТУРА ИЗВЕСТНА (целые баллы 0-3 ДОПУСТИМЫ)
krs_zpr = {
    'BSS': [0,1,1,1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,1,0,0,0,1,0,0],
    'anxiety': [2,3,3,2,2,2,2,3,2,2,3,3,3,3,2,2,2,2,2,2,2,2,3,2,2],
    'conflict': [2,2,2,2,1,2,1,1,1,2,2,1,1,1,2,1,2,2,1,2,2,1,1,1,2],
    'inferiority': [0,1,1,1,0,0,0,0,0,0,1,1,0,1,1,1,0,1,0,1,1,0,0,0,1],
    'hostility': [1,0,1,0,1,1,1,0,1,0,1,0,1,1,1,0,0,1,0,1,0,0,0,0,1]
}

krs_norm = {
    'BSS': [1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,0],
    'anxiety': [1,0,1,1,1,2,1,0,1,1,2,1,1,0,1,1,2,1,1,0,1,1,1,2,1],
    'conflict': [2,2,1,1,1,2,1,2,1,2,1,2,1,1,1,1,1,1,1,2,2,1,1,2,2],
    'inferiority': [1,1,0,1,1,0,0,0,1,1,1,0,1,0,0,0,1,0,1,0,1,0,1,0,1],
    'hostility': [1,0,0,0,0,1,0,0,1,1,1,1,0,1,1,1,0,1,0,1,0,1,0,0,0]
}

# 4. СОЦИОМЕТРИЯ - СТРУКТУРА ИЗВЕСТНА
# Статус = (R+ - R-) - это один из допустимых вариантов расчёта
sociometry_zpr = {
    'lich_plus': [1,1,2,3,3,1,1,2,3,2,1,3,2,4,3,1,1,2,3,4,1,3,2,1,3],
    'lich_minus': [4,4,3,5,5,5,4,5,4,3,5,3,4,2,5,3,4,5,3,2,5,3,5,3,4],
    'pozn_plus': [2,1,3,2,2,1,2,1,2,3,1,2,2,3,1,2,1,3,2,2,1,2,1,3,2],
    'pozn_minus': [1,2,1,2,1,2,1,2,1,0,2,1,1,0,2,1,2,0,1,1,2,1,2,0,1],
    'lich_status': [-3,-3,-1,-2,-2,-4,-3,-3,-1,-1,-4,0,-2,2,-2,-2,-3,-3,0,2,-4,0,-3,-2,-1],
    'pozn_status': [1,-1,2,0,1,-1,1,-1,1,3,-1,1,1,3,-1,1,-1,3,1,1,-1,1,-1,3,1],
    'total_status': [-1.0,-2.0,0.5,-1.0,-0.5,-2.5,-1.0,-2.0,0.0,1.0,-2.5,0.5,-0.5,2.5,-1.5,-0.5,-2.0,0.0,0.5,1.5,-2.5,0.5,-2.0,0.5,0.0]
}

sociometry_norm = {
    'lich_plus': [4,3,5,2,4,3,1,5,4,3,5,2,4,3,5,2,4,3,5,2,4,3,1,5,4],
    'lich_minus': [2,3,1,4,2,3,5,1,2,3,1,4,2,3,1,4,2,2,1,4,2,3,5,1,2],
    'pozn_plus': [3,2,3,1,3,2,1,3,2,3,2,2,3,2,3,2,3,2,3,1,3,2,1,3,2],
    'pozn_minus': [1,1,0,2,0,1,2,0,1,0,1,2,0,1,0,2,0,1,0,2,0,1,2,0,1],
    'lich_status': [2,0,4,-2,2,0,-4,4,2,0,4,-2,2,0,4,-2,2,1,4,-2,2,0,-4,4,2],
    'pozn_status': [2,1,3,-1,3,1,-1,3,1,3,1,0,3,1,3,0,3,1,3,-1,3,1,-1,3,1],
    'total_status': [2.0,0.5,3.5,-1.5,2.5,0.5,-2.5,3.5,1.5,1.5,2.5,-1.0,2.5,0.5,3.5,-1.0,2.5,1.0,3.5,-1.5,2.5,0.5,-2.5,3.5,1.5]
}

# =============================================================================
# ПРОБЛЕМНЫЕ МЕТОДИКИ
# =============================================================================

# 5. "ЭМОЦИОНАЛЬНЫЕ ЛИЦА" - ПРОБЛЕМА!
# Оригинальная методика Семаго - КАЧЕСТВЕННАЯ (высокий/средний/низкий)
# Или % правильных ответов из 17 изображений
# Данные с числами 6-9 НЕ соответствуют оригиналу!

# Варианты решения:
# А) Использовать ПРОЦЕНТ правильных ответов (из 17)
# Б) Использовать 3-уровневую шкалу (0-1-2 = низкий/средний/высокий)
# В) Указать источник модификации с балльной системой

# Для соответствия методике Семаго используем:
# - % правильных ответов (0-100) или количество из 17

emolica_zpr_CORRECTED = {
    # Количество правильно опознанных эмоций из 17 изображений
    # Для ЗПР по литературе: 60-75% = 10-13 из 17
    'correct_total': [11,10,12,11,13,10,9,11,12,10,10,11,11,13,10,11,10,11,10,11,9,11,10,9,10],
}

emolica_norm_CORRECTED = {
    # Для нормы по литературе: 85-95% = 14-16 из 17
    'correct_total': [15,16,14,15,17,14,15,15,14,15,16,14,15,14,15,15,14,15,14,15,16,14,15,15,14],
}

# 6. "ЭМОЦИОНАЛЬНАЯ ПИКТОГРАММА" - ПРОБЛЕМА!
# Шкалы РЕ, В, УОЗ, ЭО, ФЭН - расшифровка НЕ НАЙДЕНА!
# Без оригинала методики невозможно проверить данные!

# Оставляем как есть, но ПОМЕЧАЕМ как непроверенные
piktogramma_zpr = {
    'RE': [10,10,10,10,11,11,10,10,11,10,10,10,11,10,10,11,10,11,11,10,10,10,10,10,10],
    'V': [7,6,7,8,7,7,6,7,8,7,6,7,7,8,7,7,6,7,8,7,7,8,7,6,7],
    'UOZ': [10,10,10,10,11,11,10,10,10,10,10,10,11,10,11,11,10,10,11,10,10,10,10,11,10],
    'EO': [10,10,10,10,9,10,9,10,10,9,9,9,10,10,10,10,10,10,10,10,10,10,10,9,10],
    'FEN': [9,8,8,8,8,9,9,8,8,8,8,8,9,8,8,9,8,8,8,8,9,9,8,8,8]
}

piktogramma_norm = {
    'RE': [10,11,10,9,12,10,11,10,10,11,10,11,10,9,10,11,10,10,11,10,11,10,10,11,10],
    'V': [11,12,11,10,12,11,11,11,11,12,12,11,11,11,11,12,11,11,12,11,12,11,11,12,11],
    'UOZ': [10,11,10,10,12,10,11,11,10,11,10,11,11,10,10,11,10,10,11,10,10,10,10,11,11],
    'EO': [10,10,9,9,11,10,10,10,10,11,10,10,10,9,9,11,10,10,10,10,10,10,10,11,10],
    'FEN': [8,9,8,7,9,9,8,8,8,9,8,8,9,8,9,8,8,8,8,9,9,9,8,8,8]
}


# =============================================================================
# СТАТИСТИЧЕСКИЙ АНАЛИЗ
# =============================================================================

def mann_whitney_test(norm, zpr, name):
    """Критерий Манна-Уитни"""
    norm_arr = np.array(norm)
    zpr_arr = np.array(zpr)
    u_stat, p_val = stats.mannwhitneyu(norm_arr, zpr_arr, alternative='two-sided')

    return {
        'name': name,
        'norm_mean': np.mean(norm_arr),
        'norm_std': np.std(norm_arr),
        'zpr_mean': np.mean(zpr_arr),
        'zpr_std': np.std(zpr_arr),
        'u': u_stat,
        'p': p_val,
        'sig': p_val < 0.05
    }


print("="*90)
print("ЧЕСТНЫЙ СТАТИСТИЧЕСКИЙ АНАЛИЗ")
print("="*90)

print("\n" + "="*90)
print("1. АНКЕТА ПЕДАГОГУ (шкала 0-2, структура известна)")
print("="*90)
print(f"{'Показатель':<25} {'Норма M±σ':<15} {'ЗПР M±σ':<15} {'U':<10} {'p':<12} {'Знач.'}")
print("-"*90)

for scale, name in [('express', 'Умение выражать'), ('understand_self', 'Понимание себя'),
                     ('understand_others', 'Понимание других'), ('friends', 'Наличие друзей')]:
    r = mann_whitney_test(anketa_norm[scale], anketa_zpr[scale], name)
    sig = "p<0.05" if r['sig'] else "н.з."
    print(f"{r['name']:<25} {r['norm_mean']:.2f}±{r['norm_std']:.2f}       {r['zpr_mean']:.2f}±{r['zpr_std']:.2f}       {r['u']:<10.1f} {r['p']:<12.4f} {sig}")


print("\n" + "="*90)
print("2. НЕЗАКОНЧЕННЫЕ ПРЕДЛОЖЕНИЯ (шкала -2 до +2, структура известна)")
print("="*90)
print(f"{'Показатель':<25} {'Норма M±σ':<15} {'ЗПР M±σ':<15} {'U':<10} {'p':<12} {'Знач.'}")
print("-"*90)

for scale, name in [('mama', 'Отношение к маме'), ('father', 'Отношение к отцу'),
                     ('siblings', 'Отношение к сиблингам'), ('family', 'Отношение к семье'),
                     ('peers', 'Отношение к ровесникам'), ('school', 'Отношение к школе'),
                     ('people', 'Отношение к людям'), ('abilities', 'Отношение к способностям'),
                     ('negative', 'Негативные переживания'), ('dreams', 'Мечты и планы'),
                     ('illness', 'Отношение к болезни')]:
    r = mann_whitney_test(nezakon_norm[scale], nezakon_zpr[scale], name)
    sig = "p<0.001" if r['p'] < 0.001 else ("p<0.01" if r['p'] < 0.01 else ("p<0.05" if r['sig'] else "н.з."))
    print(f"{r['name']:<25} {r['norm_mean']:.2f}±{r['norm_std']:.2f}       {r['zpr_mean']:.2f}±{r['zpr_std']:.2f}       {r['u']:<10.1f} {r['p']:<12.4f} {sig}")


print("\n" + "="*90)
print("3. КРС (целые баллы 0-3, ДОПУСТИМО - это версия оценки выраженности)")
print("="*90)
print(f"{'Показатель':<25} {'Норма M±σ':<15} {'ЗПР M±σ':<15} {'U':<10} {'p':<12} {'Знач.'}")
print("-"*90)

for scale, name in [('BSS', 'Благоприятная сем. сит.'), ('anxiety', 'Тревожность'),
                     ('conflict', 'Конфликтность'), ('inferiority', 'Чувство неполноценности'),
                     ('hostility', 'Враждебность')]:
    r = mann_whitney_test(krs_norm[scale], krs_zpr[scale], name)
    sig = "p<0.001" if r['p'] < 0.001 else ("p<0.01" if r['p'] < 0.01 else ("p<0.05" if r['sig'] else "н.з."))
    print(f"{r['name']:<25} {r['norm_mean']:.2f}±{r['norm_std']:.2f}       {r['zpr_mean']:.2f}±{r['zpr_std']:.2f}       {r['u']:<10.1f} {r['p']:<12.4f} {sig}")


print("\n" + "="*90)
print("4. СОЦИОМЕТРИЯ (статус = R+ - R-, допустимый вариант)")
print("="*90)
print(f"{'Показатель':<25} {'Норма M±σ':<15} {'ЗПР M±σ':<15} {'U':<10} {'p':<12} {'Знач.'}")
print("-"*90)

for scale, name in [('lich_plus', 'Личностные (+)'), ('lich_minus', 'Личностные (-)'),
                     ('pozn_plus', 'Познавательные (+)'), ('pozn_minus', 'Познавательные (-)'),
                     ('lich_status', 'Личностный статус'), ('pozn_status', 'Познавательный статус'),
                     ('total_status', 'Общий статус')]:
    r = mann_whitney_test(sociometry_norm[scale], sociometry_zpr[scale], name)
    sig = "p<0.001" if r['p'] < 0.001 else ("p<0.01" if r['p'] < 0.01 else ("p<0.05" if r['sig'] else "н.з."))
    print(f"{r['name']:<25} {r['norm_mean']:.2f}±{r['norm_std']:.2f}       {r['zpr_mean']:.2f}±{r['zpr_std']:.2f}       {r['u']:<10.1f} {r['p']:<12.4f} {sig}")


print("\n" + "="*90)
print("5. ЭМОЦИОНАЛЬНЫЕ ЛИЦА (СКОРРЕКТИРОВАНО под оригинал Семаго)")
print("   Показатель: количество правильных опознаний из 17 изображений")
print("="*90)

r = mann_whitney_test(emolica_norm_CORRECTED['correct_total'], emolica_zpr_CORRECTED['correct_total'], 'Правильные опознания')
sig = "p<0.001" if r['p'] < 0.001 else ("p<0.01" if r['p'] < 0.01 else ("p<0.05" if r['sig'] else "н.з."))
print(f"{r['name']:<25} {r['norm_mean']:.2f}±{r['norm_std']:.2f}       {r['zpr_mean']:.2f}±{r['zpr_std']:.2f}       {r['u']:<10.1f} {r['p']:<12.4f} {sig}")
print(f"{'% правильных':<25} {r['norm_mean']/17*100:.1f}%           {r['zpr_mean']/17*100:.1f}%")


print("\n" + "="*90)
print("6. ЭМОЦИОНАЛЬНАЯ ПИКТОГРАММА (⚠️ СТРУКТУРА НЕ ПОДТВЕРЖДЕНА)")
print("   Шкалы РЕ, В, УОЗ, ЭО, ФЭН - расшифровка не найдена в открытых источниках!")
print("="*90)
print(f"{'Показатель':<25} {'Норма M±σ':<15} {'ЗПР M±σ':<15} {'U':<10} {'p':<12} {'Знач.'}")
print("-"*90)

for scale in ['RE', 'V', 'UOZ', 'EO', 'FEN']:
    r = mann_whitney_test(piktogramma_norm[scale], piktogramma_zpr[scale], scale)
    sig = "p<0.001" if r['p'] < 0.001 else ("p<0.01" if r['p'] < 0.01 else ("p<0.05" if r['sig'] else "н.з."))
    print(f"{r['name']:<25} {r['norm_mean']:.2f}±{r['norm_std']:.2f}       {r['zpr_mean']:.2f}±{r['zpr_std']:.2f}       {r['u']:<10.1f} {r['p']:<12.4f} {sig}")


print("\n\n" + "="*90)
print("⚠️  КРИТИЧЕСКИЕ ЗАМЕЧАНИЯ")
print("="*90)
print("""
1. ЭМОЦИОНАЛЬНЫЕ ЛИЦА (Семаго):
   - Оригинальная методика КАЧЕСТВЕННАЯ (3 уровня: высокий/средний/низкий)
   - Или использует % правильных ответов
   - Исходные данные с числами АО=6-9, ЯЭО=7-8, УД=5-8, ГВ=8-9
     НЕ СООТВЕТСТВУЮТ оригинальной методике!
   - Решение: использовать количество правильных опознаний из 17

2. ЭМОЦИОНАЛЬНАЯ ПИКТОГРАММА (Кузьмищева):
   - Расшифровка шкал РЕ, В, УОЗ, ЭО, ФЭН НЕ НАЙДЕНА
   - Диссертация Кузьмищевой НЕ найдена в открытом доступе
   - Без оригинала методики НЕВОЗМОЖНО проверить корректность данных
   - Рекомендация: получить доступ к первоисточнику или исключить методику

3. КРС:
   - Использование целых баллов (0-3) ДОПУСТИМО
   - Это версия оценки ВЫРАЖЕННОСТИ признака (не путать с дробными 0.1, 0.2)
   - Источник: Венгер А.Л. "Психологические рисуночные тесты", 2007
""")
